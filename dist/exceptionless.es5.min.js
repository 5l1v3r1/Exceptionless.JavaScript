define(["require","exports"],function(e,t){function n(){if(!document||!document.getElementsByTagName)return null;for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++)if(e[t].src&&e[t].src.indexOf("/exceptionless")>-1)return f.parseQueryString(e[t].src.split("?").pop());return null}function r(){if(window&&window.onerror){var e=window.onerror;window.onerror=function(t,n,r,i,o){var s=m["default"];if(null!==o&&"object"==typeof o)s.submitUnhandledException(o);else{var u={message:t,stack_trace:[{file_name:n,line_number:r,column:i}]};s.createUnhandledException(new Error(t)).setMessage(t).setProperty("@error",u).submit()}if(e)try{return e(t,n,r,i,o)}catch(u){s.config.log.error("An error occurred while calling previous error handler: "+u.message)}return!1}}}var i=function(){function e(){this._lastReferenceId=null}return e.prototype.getLast=function(){return this._lastReferenceId},e.prototype.clearLast=function(){this._lastReferenceId=null},e.prototype.setLast=function(e){this._lastReferenceId=e},e}();t.InMemoryLastReferenceIdManager=i;var o=function(){function e(){}return e.prototype.info=function(e){},e.prototype.warn=function(e){},e.prototype.error=function(e){},e}();t.NullLog=o;var s=function(){function e(e,t,n){this.cancel=!1,this.client=e,this.event=t,this.contextData=n?n:new d}return Object.defineProperty(e.prototype,"log",{get:function(){return this.client.config.log},enumerable:!0,configurable:!0}),e}();t.EventPluginContext=s;var u=function(){function e(){}return e.run=function(e){return e.client.config.plugins.reduce(function(t,n){return t.then(function(){return n.run(e)})},Promise.resolve())},e.addDefaultPlugins=function(e){e.addPlugin(new y),e.addPlugin(new b),e.addPlugin(new _),e.addPlugin(new w),e.addPlugin(new E),e.addPlugin(new P)},e}();t.EventPluginManager=u;var a=function(){function e(){this.priority=20,this.name="ReferenceIdPlugin"}return e.prototype.run=function(e){return e.event.reference_id&&0!==e.event.reference_id.length||"error"!==e.event.type||(e.event.reference_id=f.guid().replace("-","").substring(0,10)),Promise.resolve()},e}();t.ReferenceIdPlugin=a;var c=function(){function e(e){this._processingQueue=!1,this._config=e}return e.prototype.enqueue=function(e){if(this.ensureQueueTimer(),this.areQueuedItemsDiscarded())return void this._config.log.info("Queue items are currently being discarded. The event will not be queued.");var t=this.queuePath()+"-"+(new Date).toJSON()+"-"+f.randomNumber();return this._config.log.info("Enqueuing event: "+t),this._config.storage.save(t,e)},e.prototype.process=function(){var e=this;if(this.ensureQueueTimer(),!this._processingQueue){if(this._config.log.info("Processing queue..."),!this._config.enabled)return void this._config.log.info("Configuration is disabled. The queue will not be processed.");this._processingQueue=!0;try{var t=this._config.storage.get(this.queuePath(),this._config.submissionBatchSize);if(!t||0==t.length)return void this._config.log.info("There are currently no queued events to process.");this._config.log.info("Sending "+t.length+" events to "+this._config.serverUrl+"."),this._config.submissionClient.submit(t,this._config).then(function(n){return e.processSubmissionResponse(n,t)},function(n){return e.processSubmissionResponse(n,t)}).then(function(){e._config.log.info("Finished processing queue."),e._processingQueue=!1})}catch(n){this._config.log.error("An error occurred while processing the queue: "+n),this.suspendProcessing(),this._processingQueue=!1}}},e.prototype.processSubmissionResponse=function(e,t){return e.success?void this._config.log.info("Sent "+t.length+" events to "+this._config.serverUrl+"."):e.serviceUnavailable?(this._config.log.error("Server returned service unavailable."),this.suspendProcessing(),void this.requeueEvents(t)):e.paymentRequired?(this._config.log.info("Too many events have been submitted, please upgrade your plan."),void this.suspendProcessing(null,!0,!0)):e.unableToAuthenticate?(this._config.log.info("Unable to authenticate, please check your configuration. The event will not be submitted."),void this.suspendProcessing(15)):e.notFound||e.badRequest?(this._config.log.error("Error while trying to submit data: "+e.message),void this.suspendProcessing(240)):e.requestEntityTooLarge?void(this._config.submissionBatchSize>1?(this._config.log.error("Event submission discarded for being too large. The event will be retried with a smaller events size."),this._config.submissionBatchSize=Math.max(1,Math.round(this._config.submissionBatchSize/1.5)),this.requeueEvents(t)):this._config.log.error("Event submission discarded for being too large. The event will not be submitted.")):void(e.success||(this._config.log.error("An error occurred while submitting events: "+e.message),this.suspendProcessing(),this.requeueEvents(t)))},e.prototype.ensureQueueTimer=function(){var e=this;this._queueTimer||(this._queueTimer=setInterval(function(){return e.onProcessQueue()},1e4))},e.prototype.onProcessQueue=function(){this.isQueueProcessingSuspended()||this._processingQueue||this.process()},e.prototype.suspendProcessing=function(e,t,n){if((!e||0>=e)&&(e=5),this._config.log.info("Suspending processing for "+e+" minutes."),this._suspendProcessingUntil=new Date((new Date).getTime()+6e4*e),t&&(this._discardQueuedItemsUntil=new Date((new Date).getTime()+6e4*e)),n)try{this._config.storage.clear(this.queuePath())}catch(r){}},e.prototype.requeueEvents=function(e){this._config.log.info("Requeuing "+e.length+" events.");for(var t=0;t<e.length;t++)this.enqueue(e[t])},e.prototype.isQueueProcessingSuspended=function(){return this._suspendProcessingUntil&&this._suspendProcessingUntil>new Date},e.prototype.areQueuedItemsDiscarded=function(){return this._discardQueuedItemsUntil&&this._discardQueuedItemsUntil>new Date},e.prototype.queuePath=function(){return this._config.apiKey?"ex-"+this._config.apiKey.slice(0,8)+"-q":null},e}();t.DefaultEventQueue=c;var l=function(){function e(){this._items={}}return e.prototype.save=function(e,t){return this._items[e]=t,!0},e.prototype.get=function(e,t){var n=[],r=new RegExp(e||".*");for(var i in this._items){if(n.length>=t)break;r.test(i)&&(n.push(this._items[i]),delete this._items[i])}return n},e.prototype.clear=function(e){if(!e)return void(this._items={});var t=new RegExp(e);for(var n in this._items)t.test(n)&&delete this._items[n]},e.prototype.count=function(e){var t=new RegExp(e||".*"),n=[];for(var r in this._items)t.test(r)&&n.push(r);return n.length},e}();t.InMemoryStorage=l;var f=function(){function e(){}return e.getHashCode=function(e){if(!e||0===e.length)return null;for(var t=0,n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)-t+r,t|=0}return t.toString()},e.guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e.merge=function(e,t){var n={};for(var r in e||{})e[r]&&(n[r]=e[r]);for(var r in t||{})t[r]&&(n[r]=t[r]);return n},e.parseVersion=function(e){if(!e)return null;var t=/(v?((\d+)\.(\d+)(\.(\d+))?)(?:-([\dA-Za-z\-]+(?:\.[\dA-Za-z\-]+)*))?(?:\+([\dA-Za-z\-]+(?:\.[\dA-Za-z\-]+)*))?)/,n=t.exec(e);return n&&n.length>0?n[0]:null},e.parseQueryString=function(e){if(!e||0===e.length)return null;var t=e.split("&");if(0===t.length)return null;for(var n={},r=0;r<t.length;r++){var i=t[r].split("=");n[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return n},e.randomNumber=function(){return Math.floor(9007199254740992*Math.random())},e.stringify=function(e){var t=[];return JSON.stringify(e,function(e,n){if("object"==typeof n&&null!==n){if(-1!==t.indexOf(n))return;t.push(n)}return n})},e}();t.Utils=f;var p=function(){function e(t){function n(e){return"function"==typeof e?e(this):e}this._enabled=!1,this._serverUrl="https://collector.exceptionless.io",this._plugins=[],this.lastReferenceIdManager=new i,this.defaultTags=[],this.defaultData={},t=f.merge(e.defaults,t),this.apiKey=t.apiKey,this.serverUrl=t.serverUrl,this.lastReferenceIdManager=n(t.lastReferenceIdManager)||new i,this.log=n(t.log)||new o,this.submissionBatchSize=n(t.submissionBatchSize)||50,this.submissionClient=n(t.submissionClient),this.storage=n(t.storage)||new l,this.queue=n(t.queue)||new c(this),u.addDefaultPlugins(this)}return Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._apiKey},set:function(e){this._apiKey=e||null,this._enabled=!!e&&e.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverUrl",{get:function(){return this._serverUrl},set:function(e){e&&e.length>0&&(this._serverUrl=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"plugins",{get:function(){return this._plugins.sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0})},enumerable:!0,configurable:!0}),e.prototype.addPlugin=function(e,t,n){var r=n?{name:e,priority:t,run:n}:e;if(!r||!r.run)return void this.log.error("Unable to add plugin: No run method was found.");r.name||(r.name=f.guid()),r.priority||(r.priority=0);for(var i=!1,o=0;o<this._plugins.length;o++)if(this._plugins[o].name===r.name){i=!0;break}i||this._plugins.push(r)},e.prototype.removePlugin=function(e){var t="string"==typeof e?e:e.name;if(!t)return void this.log.error("Unable to remove plugin: No plugin name was specified.");for(var n=0;n<this._plugins.length;n++)if(this._plugins[n].name===t){this._plugins.splice(n,1);break}},e.prototype.useReferenceIds=function(){this.addPlugin(new a)},Object.defineProperty(e,"defaults",{get:function(){return null===e._defaultSettings&&(e._defaultSettings={}),e._defaultSettings},enumerable:!0,configurable:!0}),e._defaultSettings=null,e}();t.Configuration=p;var g=function(){function e(e,t,n,r,i){void 0===n&&(n=-1),void 0===r&&(r=null),void 0===i&&(i=null),this.success=!1,this.settingsVersion=-1,this.success=e,this.settings=t,this.settingsVersion=n,this.exception=r,this.message=i}return e}();t.SettingsResponse=g;var h=function(){function e(e,t){this.success=!1,this.badRequest=!1,this.serviceUnavailable=!1,this.paymentRequired=!1,this.unableToAuthenticate=!1,this.notFound=!1,this.requestEntityTooLarge=!1,this.statusCode=e,this.message=t,this.success=e>=200&&299>=e,this.badRequest=400===e,this.serviceUnavailable=503===e,this.paymentRequired=402===e,this.unableToAuthenticate=401===e||403===e,this.notFound=404===e,this.requestEntityTooLarge=413===e}return e}();t.SubmissionResponse=h;var d=function(){function e(){}return e.prototype.setException=function(e){this["@@_Exception"]=e},Object.defineProperty(e.prototype,"hasException",{get:function(){return!!this["@@_Exception"]},enumerable:!0,configurable:!0}),e.prototype.getException=function(){return this.hasException?this["@@_Exception"]:null},e.prototype.markAsUnhandledError=function(){this["@@_IsUnhandledError"]=!0},Object.defineProperty(e.prototype,"isUnhandledError",{get:function(){return!!this["@@_IsUnhandledError"]},enumerable:!0,configurable:!0}),e.prototype.setSubmissionMethod=function(e){this["@@_SubmissionMethod"]=e},e.prototype.getSubmissionMethod=function(){return this["@@_SubmissionMethod"]?null:this["@@_SubmissionMethod"]},e}();t.ContextData=d;var v=function(){function e(e,t,n){this.target=e,this.client=t,this.pluginContextData=n}return e.prototype.setType=function(e){return e&&e.length>0&&(this.target.type=e),this},e.prototype.setSource=function(e){return e&&e.length>0&&(this.target.source=e),this},e.prototype.setSessionId=function(e){if(!this.isValidIdentifier(e))throw new Error("SessionId must contain between 8 and 100 alphanumeric or '-' characters.");return this.target.session_id=e,this},e.prototype.setReferenceId=function(e){if(!this.isValidIdentifier(e))throw new Error("SessionId must contain between 8 and 100 alphanumeric or '-' characters.");return this.target.reference_id=e,this},e.prototype.setMessage=function(e){return e&&e.length>0&&(this.target.message=e),this},e.prototype.setGeo=function(e,t){if(-90>e||e>90)throw new Error("Must be a valid latitude value between -90.0 and 90.0.");if(-180>t||t>180)throw new Error("Must be a valid longitude value between -180.0 and 180.0.");return this.target.geo=e+","+t,this},e.prototype.setValue=function(e){return e&&(this.target.value=e),this},e.prototype.addTags=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(!e||0===e.length)return this;this.target.tags||(this.target.tags=[]);for(var n=0;n<e.length;n++)e[n]&&this.target.tags.indexOf(e[n])<0&&this.target.tags.push(e[n]);return this},e.prototype.setProperty=function(e,t){return e&&void 0!==t&&null!=t?(this.target.data||(this.target.data={}),this.target.data[e]=t,this):this},e.prototype.markAsCritical=function(e){return e&&this.addTags("Critical"),this},e.prototype.submit=function(){return this.client.submitEvent(this.target,this.pluginContextData)},e.prototype.isValidIdentifier=function(e){if(!e||!e.length)return!0;if(e.length<8||e.length>100)return!1;for(var t=0;t<e.length;t++){var n=e.charCodeAt(t),r=n>=48&&57>=n,i=n>=65&&90>=n||n>=97&&122>=n,o=45===n;if(!r&&!i&&!o)return!1}return!0},e}();t.EventBuilder=v;var m=function(){function e(e,t){this.config=new p("object"!=typeof e?e:{apiKey:e,serverUrl:t})}return e.prototype.createException=function(e){var t=new d;return t.setException(e),this.createEvent(t).setType("error")},e.prototype.submitException=function(e){return this.createException(e).submit()},e.prototype.createUnhandledException=function(e){var t=this.createException(e);return t.pluginContextData.markAsUnhandledError(),t},e.prototype.submitUnhandledException=function(e){return this.createUnhandledException(e).submit()},e.prototype.createFeatureUsage=function(e){return this.createEvent().setType("usage").setSource(e)},e.prototype.submitFeatureUsage=function(e){return this.createFeatureUsage(e).submit()},e.prototype.createLog=function(e,t,n){var r=this.createEvent().setType("log");if(e&&t&&n)r=r.setSource(e).setMessage(t).setProperty("@level",n);else if(e&&t)r=r.setSource(e).setMessage(t);else{var i=arguments.callee.caller.name;r=r.setSource(i).setMessage(e)}return r},e.prototype.submitLog=function(e,t,n){return this.createLog(e,t,n).submit()},e.prototype.createNotFound=function(e){return this.createEvent().setType("404").setSource(e)},e.prototype.submitNotFound=function(e){return this.createNotFound(e).submit()},e.prototype.createSessionStart=function(e){return this.createEvent().setType("start").setSessionId(e)},e.prototype.submitSessionStart=function(e){return this.createSessionStart(e).submit()},e.prototype.createSessionEnd=function(e){return this.createEvent().setType("end").setSessionId(e)},e.prototype.submitSessionEnd=function(e){return this.createSessionEnd(e).submit()},e.prototype.createEvent=function(e){return new v({date:new Date},this,e)},e.prototype.submitEvent=function(e,t){var n=this;if(!e)return Promise.reject(new Error("Unable to submit undefined event."));if(!this.config.enabled){var r="Event submission is currently disabled.";return this.config.log.info(r),Promise.reject(new Error(r))}var i=new s(this,e,t);return u.run(i).then(function(){if(i.cancel){var t='Event submission cancelled by plugin": id='+e.reference_id+" type="+e.type;return n.config.log.info(t),Promise.reject(new Error(t))}return e.type&&0!==e.type.length||(e.type="log"),e.date||(e.date=new Date),n.config.log.info("Submitting event: type="+e.type+!!e.reference_id?" refid="+e.reference_id:""),n.config.queue.enqueue(e),e.reference_id&&e.reference_id.length>0&&(n.config.log.info('Setting last reference id "'+e.reference_id+'"'),n.config.lastReferenceIdManager.setLast(e.reference_id)),Promise.resolve()})["catch"](function(e){var t=e.message?e.message:e;return n.config.log.error(t),Promise.reject(new Error(t))})},e.prototype.getLastReferenceId=function(){return this.config.lastReferenceIdManager.getLast()},Object.defineProperty(e,"default",{get:function(){return null===e._instance&&(e._instance=new e(null)),e._instance},enumerable:!0,configurable:!0}),e._instance=null,e}();t.ExceptionlessClient=m;var y=function(){function e(){this.priority=10,this.name="ConfigurationDefaultsPlugin"}return e.prototype.run=function(e){if(e.client.config.defaultTags){e.event.tags||(e.event.tags=[]);for(var t=0;t<e.client.config.defaultTags.length;t++){var n=e.client.config.defaultTags[t];n&&e.client.config.defaultTags.indexOf(n)<0&&e.event.tags.push(n)}}if(e.client.config.defaultData){e.event.data||(e.event.data={});for(var r in e.client.config.defaultData)e.client.config.defaultData[r]&&(e.event.data[r]=e.client.config.defaultData[r])}return Promise.resolve()},e}();t.ConfigurationDefaultsPlugin=y;var b=function(){function e(){this.priority=30,this.name="ErrorPlugin"}return e.prototype.run=function(e){var t=this,n=e.contextData.getException();return null==n?Promise.resolve():(e.event.data||(e.event.data={}),e.event.type="error",e.event.data["@error"]?Promise.resolve():StackTrace.fromError(n).then(function(r){return t.processError(e,n,r)},function(){return t.onParseError(e)}))},e.prototype.processError=function(e,t,n){var r={message:t.message,stack_trace:this.getStackFrames(e,n||[])};return e.event.data["@error"]=r,Promise.resolve()},e.prototype.onParseError=function(e){return e.cancel=!0,Promise.reject(new Error("Unable to parse the exceptions stack trace. This exception will be discarded."))},e.prototype.getStackFrames=function(e,t){for(var n=[],r=0;r<t.length;r++)n.push({name:t[r].functionName,file_name:t[r].fileName,line_number:t[r].lineNumber,column:t[r].columnNumber});return n},e}();t.ErrorPlugin=b;var _=function(){function e(){this.priority=50,this.name="DuplicateCheckerPlugin"}return e.prototype.run=function(e){return Promise.resolve()},e}();t.DuplicateCheckerPlugin=_;var w=function(){function e(){this.priority=40,this.name="ModuleInfoPlugin"}return e.prototype.run=function(e){if(!e.event.data||!e.event.data["@error"]||e.event.data["@error"].modules)return Promise.resolve();try{if(document&&document.getElementsByTagName){var t=this.getFromDocument();t&&t.length>0&&(e.event.data["@error"].modules=t)}}catch(n){e.log.error("Unable to get module info. Exception: "+n.message)}return Promise.resolve()},e.prototype.getFromDocument=function(){var e=[],t=document.getElementsByTagName("script");if(t&&t.length>0)for(var n=0;n<t.length;n++)t[n].src?e.push({module_id:n,name:t[n].src,version:f.parseVersion(t[n].src)}):t[n].innerHTML&&e.push({module_id:n,name:"Script Tag",version:f.getHashCode(t[n].innerHTML)});return e},e}();t.ModuleInfoPlugin=w;var E=function(){function e(){this.priority=60,this.name="RequestInfoPlugin"}return e.prototype.run=function(e){if(e.event.data&&e.event.data["@request"])return Promise.resolve();e.event.data||(e.event.data={});var t={user_agent:navigator.userAgent,is_secure:"https:"===location.protocol,host:location.hostname,port:location.port&&""!==location.port?parseInt(location.port):80,path:location.pathname,cookies:this.getCookies(),query_string:f.parseQueryString(location.search.substring(1))};return document.referrer&&""!==document.referrer&&(t.referrer=document.referrer),e.event.data["@request"]=t,Promise.resolve()},e.prototype.getCookies=function(){if(!document.cookie)return null;for(var e={},t=document.cookie.split(", "),n=0;n<t.length;n++){var r=t[n].split("=");e[r[0]]=r[1]}return e},e}();t.RequestInfoPlugin=E;var P=function(){function e(){this.priority=100,this.name="SubmissionMethodPlugin"}return e.prototype.run=function(e){var t=e.contextData.getSubmissionMethod();return t&&(e.event.data||(e.event.data={}),e.event.data["@submission_method"]=t),Promise.resolve()},e}();t.SubmissionMethodPlugin=P;var S=function(){function e(){}return e.prototype.info=function(e){console&&console.log&&console.log("[INFO] Exceptionless:"+e)},e.prototype.warn=function(e){console&&console.log&&console.log("[Warn] Exceptionless:"+e)},e.prototype.error=function(e){console&&console.log&&console.log("[Error] Exceptionless:"+e)},e}();t.ConsoleLog=S;var R=function(){function e(){}return e.prototype.submit=function(e,t){var n=this,r=t.serverUrl+"/api/v2/events?access_token="+encodeURIComponent(t.apiKey);return this.sendRequest("POST",r,f.stringify(e)).then(function(e){return new h(e.status,n.getResponseMessage(e))},function(e){return new h(e.status||500,n.getResponseMessage(e))})},e.prototype.submitDescription=function(e,t,n){var r=this,i=n.serverUrl+"/api/v2/events/by-ref/"+encodeURIComponent(e)+"/user-description?access_token="+encodeURIComponent(n.apiKey);return this.sendRequest("POST",i,f.stringify(t)).then(function(e){return new h(e.status,r.getResponseMessage(e))},function(e){return new h(e.status||500,r.getResponseMessage(e))})},e.prototype.getSettings=function(e){var t=this,n=e.serverUrl+"/api/v2/projects/config?access_token="+encodeURIComponent(e.apiKey);return this.sendRequest("GET",n).then(function(n){if(200!==n.status)return new g(!1,null,-1,null,"Unable to retrieve configuration settings: "+t.getResponseMessage(n));var r;try{r=JSON.parse(n.responseText)}catch(i){e.log.error('An error occurred while parsing the settings response text: "'+n.responseText+'"')}return r&&r.settings&&r.version?new g(!0,r.settings,r.version):new g(!0,null,-1,null,"Invalid configuration settings.")},function(e){return new g(!1,null,-1,null,t.getResponseMessage(e))})},e.prototype.getResponseMessage=function(e){if(!e||e.status>=200&&e.status<=299)return null;if(0===e.status)return"Unable to connect to server.";if(e.responseBody)return e.responseBody.message;if(e.responseText)try{return JSON.parse(e.responseText).message}catch(t){return e.responseText}return e.statusText},e.prototype.createRequest=function(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,n&&("POST"===e&&n.setRequestHeader&&n.setRequestHeader("Content-Type","application/json"),n.timeout=1e4),n},e.prototype.sendRequest=function(e,t,n){var r=this.createRequest(e||"POST",t);return new Promise(function(e,t){return r?("withCredentials"in r&&(r.onreadystatechange=function(){4===r.readyState&&(r.status>=200&&r.status<=299?e(r):t(r))}),r.ontimeout=function(){return t(r)},r.onerror=function(){return t(r)},r.onload=function(){return e(r)},void r.send(n)):t({status:503,message:"CORS not supported."})})},e}();t.DefaultSubmissionClient=R;var T=n();T&&(T.apiKey||T.serverUrl)&&(p.defaults.apiKey=T.apiKey,p.defaults.serverUrl=T.serverUrl),p.defaults.submissionClient=new R,r()});
//# sourceMappingURL=exceptionless.es5.min.js.map