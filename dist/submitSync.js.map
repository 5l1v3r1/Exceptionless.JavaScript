{"version":3,"file":"submitSync.js","sourceRoot":"/source/","sources":["submitSync.ts"],"names":["NodeSubmissionAdapter","NodeSubmissionAdapter.constructor","NodeSubmissionAdapter.sendRequest","NodeSubmissionAdapter.complete","NodeSubmissionAdapter.sendRequestSync"],"mappings":"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","sourcesContent":["import * as events from \"events\";\nimport * as net from \"net\";\nimport * as stream from \"stream\";\nimport * as child from \"child_process\";\nimport * as tls from \"tls\";\nimport * as http from \"http\";\nimport * as crypto from \"crypto\";\nimport https = require('https');\nimport url = require('url');\nimport { StringDecoder } from 'string_decoder';\nexport interface SubmissionCallback {\n  (status: number, message: string, data?: string, headers?: Object): void;\n}\n\nexport interface SubmissionRequest {\n  serverUrl: string;\n  apiKey: string;\n  userAgent: string;\n  method: string;\n  path: string;\n  data: string;\n}\n\n                                                                                                                   \n\nexport interface ISubmissionAdapter {\n  sendRequest(request: SubmissionRequest, callback: SubmissionCallback, isAppExiting?: boolean): void;\n}\n\n                                                                                                                                                                                                                                                                                                                     \n\nexport class NodeSubmissionAdapter implements ISubmissionAdapter {\n  public sendRequest(request: SubmissionRequest, callback: SubmissionCallback, isAppExiting?: boolean) {\n    if (isAppExiting) {\n      this.sendRequestSync(request, callback);\n      return;\n    }\n\n    let parsedHost = url.parse(request.serverUrl);\n\n    let options: https.RequestOptions = {\n      auth: `client:${request.apiKey}`,\n      headers: {},\n      hostname: parsedHost.hostname,\n      method: request.method,\n      port: parsedHost.port && parseInt(parsedHost.port, 10),\n      path: request.path\n    };\n\n    options.headers['User-Agent'] = request.userAgent;\n\n    if (request.method === 'POST') {\n      options.headers = {\n        'Content-Type': 'application/json',\n        'Content-Length': request.data.length\n      };\n    }\n\n    let protocol = (parsedHost.protocol === 'https' ? https : http);\n    let clientRequest: http.ClientRequest = protocol.request(options, (response: http.IncomingMessage) => {\n      let body = '';\n      response.setEncoding('utf8');\n      response.on('data', (chunk) => body += chunk);\n      response.on('end', () => this.complete(response, body, response.headers, callback));\n    });\n\n    clientRequest.on('error', (error: Error) => callback(500, error.message));\n    clientRequest.end(request.data);\n  }\n\n  private complete(response: http.IncomingMessage, responseBody: string, responseHeaders: Object, callback: SubmissionCallback): void {\n    let message: string;\n    if (response.statusCode === 0) {\n      message = 'Unable to connect to server.';\n    } else if (response.statusCode < 200 || response.statusCode > 299) {\n      message = response.statusMessage || (<any>response).message;\n    }\n\n    callback(response.statusCode || 500, message, responseBody, responseHeaders);\n  }\n\n  private sendRequestSync(request: SubmissionRequest, callback: SubmissionCallback): void {\n    let requestJson = JSON.stringify(request);\n    let res = child.spawnSync(process.execPath, [require.resolve('./submitSync.js')],\n      {\n        input: requestJson,\n        stdio: ['pipe', 'pipe', process.stderr]\n      });\n\n    let out = res.stdout.toString();\n    let result = JSON.parse(out);\n\n    callback(result.status, result.message, result.data, result.headers);\n  }\n}\n\n                                                                                                                                                                                                                                  \n\nlet decoder = new StringDecoder('utf8');\nlet strings: string[] = [];\n\nlet jsonStream = new stream.Writable();\njsonStream._write = (chunk: Buffer | string, encoding: string, next: Function) => {\n  strings.push(decoder.write(<Buffer>chunk));\n  next();\n};\n\njsonStream.on('finish', () => {\n  let json = strings.join('');\n  let request: SubmissionRequest = JSON.parse(json);\n  let adapter = new NodeSubmissionAdapter();\n  adapter.sendRequest(request, (status, message, data, headers) => {\n    let result = {\n      status,\n      message,\n      data,\n      headers\n    };\n    process.stdout.write(JSON.stringify(result));\n    process.exit(0);\n  });\n});\n\nprocess.stdin.pipe(jsonStream);\n\n"]}